# Stage 1: Cache Gradle dependencies
FROM gradle:latest AS cache
WORKDIR /home/gradle/app
COPY gradle/ gradle/
COPY gradle.properties settings.gradle.kts build.gradle.kts ./
RUN gradle --no-daemon dependencies

# Stage 2: Build Application
FROM gradle:latest AS build
COPY --from=cache /home/gradle/.gradle /home/gradle/.gradle
WORKDIR /home/gradle/app
COPY . .
RUN gradle buildFatJar --no-daemon --stacktrace

# Stage 3: Runtime Image
FROM amazoncorretto:22
WORKDIR /app
COPY --from=build /home/gradle/app/build/libs/*.jar /app/ktor-app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app/ktor-app.jar"]
